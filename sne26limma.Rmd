
```{r}
datadir <- "~/lab/chunks/heatshockStephensProject/data/"
mdatar <- read.csv(paste0(datadir,"countedDataForAnalysissne26.csv"))
datar <- dcast(subset(mdatar,Tag=="UP"),Strain~SampleNum+whichRun+Q+time+replicate,value.var="Counts")
rownames(datar) <- datar[,1]
datar <- datar[,-1]
```

That read in the data. If you are not Darach and you're running this,
you'll have to get your data in somewhere else.


How do the counts look? So we're looking across each row of genes,
and we're asking how many counts do we have?

```{r}
plot(density(apply(datar,1,function(x){sum(x)}),0.1))
```

Basically, I looped between this and looking at the mean vs var
plot from limma, and picked this cut off

```{r}
plot(density(apply(datar,1,function(x){sum(x)})[apply(datar,1,function(x){sum(x)})>15],0.1))

sdatar <- datar[apply(datar,1,function(x){sum(x)})>15,]
```


Here we build the design matrix.

```{r}
d <- dcast(subset(mdatar,Tag=="UP"),
  SampleNum+whichRun+Q+time+replicate~.,value.var="Counts")
d$whichRun <- factor(d$whichRun)
d$shifted <- ifelse(grepl("preShift",d$time),FALSE,TRUE)
d$shocked <- ifelse(grepl("preShock",d$time),FALSE,TRUE)
design <- model.matrix(~d$whichRun+d$shifted+d$shocked+d$shifted:d$Q+d$shocked)
design
```

And now voom-itize and limma that sucka.

```{r}
library(limma)
vdatar <- voom(sdatar,design=design,plot=T)
fit <- lmFit(vdatar,design)
```

Then pick contrasts to look at, basically that's a vector of values
that show which weights we're testing for difference associated.

```{r}
head(design)
```

Which are differentially abundant between the two runs?
```{r}
runDiff <- eBayes(contrasts.fit(fit,c(0,1,0,0,0,0)))
runDiffTable <- topTable(runDiff,sort.by="logFC",number=10000)
runDiffTable[order(runDiffTable$logFC,decreasing=T),][1:20,]
```

Which are different in the shift or not?
```{r}
shiftDiff <- eBayes(contrasts.fit(fit,c(0,0,1,0,0,0)))
shiftDiffTable <- topTable(shiftDiff,sort.by="logFC",number=10000)
shiftDiffTable[order(shiftDiffTable$logFC,decreasing=F),][1:20,]
```
Here are the top most reduced which you do the shift.

Which different when shocked?
```{r}
shockDiff <- eBayes(contrasts.fit(fit,c(0,0,0,1,0,0)))
shockDiffTable <- topTable(shockDiff,sort.by="logFC",number=10000)
shockDiffTable[order(shockDiffTable$logFC,decreasing=T),][1:20,]
```
Here's the ones that are more abundant when you heatshock.

And when you heatshock and upshift with glutamine?
```{r}
qshockDiff <- eBayes(contrasts.fit(fit,c(0,0,0,1,0,1)))
qshockDiffTable <- topTable(qshockDiff,sort.by="logFC",number=10000)
qshockDiffTable[order(qshockDiffTable$logFC,decreasing=T),][1:20,]
```

And when you simply consider glutamine?
```{r}
qDiff <- eBayes(contrasts.fit(fit,c(0,0,0,1,0,1)))
qDiffTable <- topTable(qDiff,sort.by="logFC",number=10000)
qDiffTable[order(qDiffTable$logFC,decreasing=T),][1:20,]
```



